---
title: "MAN IN THE MIDDLE ATTACK"
layout: post
---


**1. Giao thức ARP**

Đây là một giao thức mạng dùng để tìm ra địa chỉ MAC của một thiết bị từ một IP nguồn.
VD: Thiết bị sẽ gửi 1 ARP request chưa IP của thiết bị nhận. Tất cả các mạng trong local network sẽ nhận đc gói tin nhưng chỉ có thiết bị khớp với IP trong gói ARP mới có thể phản hồi lại thông tin với thông điệp chứa địa chỉ MAC của nó.

**2. ARP Spoofing**

![ARP SPOOFING DIAGRAM](https://dsm01pap003files.storage.live.com/y4mF4Cj0m0f88khpHqP9g5cE9dUjUv3O8uMex1DlpNnTBfCrvZs3Jwp-wh9GYsOTdr_PwLvsiuh-Ooa2X-0obMbBl-6Uct0YWsvsaAxCiEz1vAb48IyOJJ-dWn-vI7O2DYY7AxfN7QQzGDb3Mnh6qwQhWEaWQCG_TzD_R0ybvqgV9rgLO6bczPm4-L8Ey9sA5ZrUVhOEtP9OrYuLfRtHHeY00yXBfph61Kv3gghUXQof20?width=570&height=295&cropmode=center)

ARP Spoofing cho phép chuyển hướng các packet cho nên thay vì các packet được gửi thẳng đến máy victim (như sơ đồ), nó sẽ đi qua máy tính của hacker. Như vậy các request cũng như respond sẽ đều phải đi qua máy tính của hacker → Cho phép hacker đọc, chỉnh sửa cũng như chặn các gói tin này.

**3. ARPSPOOF Tool**

Máy thực hiện tấn công: Kali linux 2022
Máy mục tiêu: Windows 10
Để hiển thị bảng dữ liệu arp, chúng ta sử dụng lệnh: arp -a


![arp-a command](https://dsm01pap003files.storage.live.com/y4mmbreHb3jLMQUv_VbUu8qTytNZrJiLXlc8GGAc4ZLswe5m0Sc8YpBjjsxXaxtTLLBrKE2tNZlMTxCNaBhxvJ0MO7sIZoEOOGgnTFZZRGnnc7zEsl3mz_JESvaLZAkkFalQVPVlSfaE7UnjXGziE9ADuLF6ToxDwWrVql9BGhemdBpJ1Aja3abAXeHiZi-LWdgUg4tBNzoKEigjzZ4Vf6W4v082UjZVnh_jPKL5ts6U9U?encodeFailures=1&width=622&height=99)

Sử dụng arpspoof:
**arpspoof -i [name_interface] -t [IP_victim] [IP_gateway]**: Gửi request đến máy nạn nhân nói rằng mình là router

**arpspoof -i [name_interface] -t [IP_victim] [IP_gateway]** Gửi request đến router nói rằng mình là máy victim

![Thực hiện chạy đồng thời](https://dsm01pap003files.storage.live.com/y4mp7nXvbDiG7iL79j6b6-xYkLCXkNGyniUPj9-I3J7GC3cbMFeoBoGvYjOCAEAIK4GnUatWlVKJ8MiP4fUNNtf11DuqzsOb4XE6GCfn7uKAAW0WqaTmQWe0ExBhVBhMsltOtKQ-rqlFZ1EicJP2G9r-NJrhXbief0_iwnhobdzGh7ND5p2ZQWpYYCk4ZzORhAtguJT1HinI8--lwwzX-FODy6VXVPDcIgnN6-M2zvWHyw?encodeFailures=1&width=622&height=225)


![Kết quả bảng arp máy windows 10](https://dsm01pap003files.storage.live.com/y4mGx4BSzVSE2MNv5fsftE8kJ_UX_t_1RvXI2Dh4_1wvv5JftoZsHK4bAyPehrm8aJTcdtyduYSr3OCFAx9KR24iBijghpB4R4tv6WQR8cB3u6K0dkpicbr-rNYIBz1rKQbWc4OghcmFKxagf-yOQoxQmt4mjP1NL7GUPYF0SDIdvTd1y2oc7moLBguP72Yr1EBn_fWPnbn_Fj-9LrUhB07vaprFlUPY_x4MKLUJXwl_mE?encodeFailures=1&width=561&height=327)

Vì kali linux không phải router nên khi có request nó sẽ không cho những request này qua và chặn chúng lại( tính năng của kali). Vì vậy để những request này đến router chúng ta phải mở cổng chuyển tiếp giống như 1 bộ định tuyến

![ip-forwarder](https://dsm01pap003files.storage.live.com/y4m6cq5Wuj7nNlM_9GnYxDw9DmcnmVIAhnkAOkSvQH_HDLNykDcrqrfye7BaVwRBwbMrhzv5zftqT-ezfU8hBQvmA6UxjygqyRR0tSZhL2ZyCWa3fhD4P3adJhedpkkjy-f02u_xgnGr-tcVL94D1SwcayDkq3Nwvs_4Uvl7x7ILjqrZUO60gRUV2ccp6v0-hjXOqKnDncSxYff3WEt8AyrNVxZmZobU-Ww35TJe6_vtcE?encodeFailures=1&width=444&height=82)

**ARP Spoofing using Bettercap**

Đây là một framework để tấn công mạng
Nó có thể được dùng cho:
- ARP Spoof ( chuyển hướng các packet)
- Sniff data
- Bypass HTTPS
- DNS Spoofing
- Inject code in loaded pages
- Nhiều cái khác nữa

*Thực hành*
Khởi động bettercap: **bettercap -iface [name_interface_network]**

![Khởi động bettercap](https://dsm01pap003files.storage.live.com/y4mn5PxTqiiSL-EGqTGjCbgh0RUunlGcAuX9hi5D-CVOetujyhQUjjX6FiP35Hfi5pkivZT9DqqAJZx68oD5yUx1X3jtzK6BxmMdyzwxyZwWflr7R80xRpDOTm5FS2J1Od0bwLm0YFAlxNCZdDYIDWbi6mp9EmkhbTIotx4-feVZy6PIxHetzT1BlUCNoDvnhFYq8IEna5nJYVlSetFHxv87Ww6NjzMkYizkM8qiZAVVL8?encodeFailures=1&width=623&height=208)

Có thể dùng lệnh **help** để xem tất cả những command có thể dùng với bettercap

Bettercap có những modules chúng ta có thể dùng, ở chế độ mặc định thì có module **events.stream** đang được chạy ngầm để handle tất cả các events

![4-ành](https://dsm01pap003files.storage.live.com/y4mTZRE7Ajw1kekpvlj_JtNT__U9CoQgwZKvBqqUhec4e2MfC_S4lKl-re1mJad8OBHBOEcLixBIcc9fJ0x7ma89hfrqxjnppAgJVldM9M0QsNDxrhQeUvOI10DhVM4Sxmr9dz04tllsAKw03YetHvbSQ8xiO88Sq4REALFiSXQXLafTiI6frxrZsqtfm7mu1xmqgENX3V2uauC4nJuJHJX8hpbHrbZiqKzHGcY3suxX0o?encodeFailures=1&width=245&height=322)

Ở đây chúng ta sẽ sử dụng modules **net.probe**. Module này được sử dụng để gửi các gói UDP để tìm ra các thiết bị mạng trong local network

Start net.probe: **net.probe on**

![4-anh 4](https://dsm01pap003files.storage.live.com/y4mjw7dqDTOMBBUBZC_PnES3R9QBPVdC-RRUrFmu7nrOr_k4LH3AMNfkdEYzGD_zKrzFTfBImnPwj0vPiuCyWmXK_i3oFo7qbq5-Bl9-MjP2FRjhNzxDAtiJylpuXO1VLIgBP3oM0sqbiu-NUZ753qKL8XkdxqUkFnf9a-o6q9Z38SpIl3sNee4JuDLIR-TBUKYutXMrZUBukdBhJRAidAImVpNnojxBDmoqfHzlTltJU0?encodeFailures=1&width=628&height=154)

Có thể thấy ip 192.168.245.133 là ip của máy windows 10 mà chúng ta đã sử dụng ở phần trên.

Khi start net.probe, net.recon sẽ tự động start. Net.probe gửi request đến tất các các ip trong mạng và khi có respond, net.recon sẽ phát hiện respond bằng cách theo dõi arp cache và sau đó thêm những IP này vào 1 danh sách để ta có thể nhắm vào tấn công.

Thực hiện lệnh: **net.show** để xem tất cả các thiết bị được kết nối

![4-anh 4](https://dsm01pap003files.storage.live.com/y4mxQXSIr3u9sin7WujMAjdwdgbDQUZeo8b8K9ZnFDmP2ymnF263A8SSTXbnCGMcymwq1GZt0RkQt3jy5mA-_c_6gkuXLE7hQIMCgn3wXyLteZeaSGygks_IvdB3VGzQx5g9BUKoBY1qNsCmtR_YFTFmJfPoB1EpqEaZLOyZq83HpHr3UKWIPNbCcHF7n1sAhqMhJf6biNQvWjFzsl_SAvohT_9Vo3LCj53npnk6c_GF2w?encodeFailures=1&width=624&height=187)

Tiếp theo, chúng ta cần trở thành **Man in the middle**, ở đây sẽ sử dụng module **arp.spoof** 

Trước khi start arp.spoof, chúng ta cần thiết lập lại một số thành phần trong module arp.spoof

Thứ nhất, **set arp.spoof.fullduplex true**, hiểu đơn giản là sẽ spoof cả router và máy victim như chúng ta đã thực hiện ở phần trên với arp spoofing tool. Ở mặc định thì biến này sẽ được gán là false và nó sẽ chỉ spoof target machine

Thứ hai, set arp.spoof.targets [IP_victim_machine]

Cuối cùng, start arp.spoof








